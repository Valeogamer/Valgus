# Valgus / Определение плоско-вальгусной деформации стопы методами машинного обучения.

___

#### Плоско-вальгусная деформация стопы
#### Данный репозиторий посвящен разработке приложения для определения плоско-вальгусной деформации стопы с использованием методов машинного обучения.
#### Является результатом ВКР и показателем полученных навыков в течении всего учебного процесса.

## Цель

___
#### Разработать приложение (алгоритм) для определения по фото плоско-вальгусной деформации стопы.

## Задачи

___

- [x] Рассмотреть полезные библиотеки.
- [x] Разработать варианты решения.
- [x] Реализовать алгоритмы.
- [x] Реализовать варианты решения:
    - [x] написать тестовую модель НС, протестировать
    - [x] написать тестовый вариант инструмента для ручной обработки и классификации
- [x] Валидация (рассмотреть на новых данных как поведут себя модели НС)
- [x] Оценка моделей (производительность и ...)
- [ ] GUI, UI/UX
- [ ] Готовые варианты решения собрать как приложение
- [x] Начать писать структуру ВКР:
    - Введение.
    - Обзор литературы.
    - Исследования.
    - Методология и эксперименты.
    - Результаты.
    - Обсуждения и заключение.
- Из мелких задач:
  - Реализовать блок-схемы алгоритма
  - Диаграммы (UML диаграммы пайплайна)
  - Графики
  - ... (дополнить)

## Дневник

___

### - [x] Модуль удаления заднего фона:
  (20/09/2023)
  - Чтение каталога с файлами
  - Удаление фона
  - Запись в новый созданный каталог под теми же именами (наподобие маски под оригинальное изображени)
  - Сохранение результата
### - [x] Формирование датасета из изображения:
  (30/10/2023)
  - Замена имени и расширения
  - Перевод в матричный вид
  - Стандартизация изображения
  - Формирования связки изображение - метка
  - Сохранение результата с помощью numpy и pickle
  - (new) Визуализация (проверка данных соответствует ли метка изображению)
### - [x] Модели НС:
  ### MLP:
  (01/11/2023)
  - проблема в не сбалансированном количестве данных, один класс данных преобладает над другим классом данных
    из-за этого все результаты близятся к результату, того класса у которой больше всего было данных при обучении (
    *__Дисбаланс данных__*).
    В качестве решения данной проблемы, на текущий момент попытаюсь привести данные всех классов к равному количеству.
    А также, чтобы пропорционально увеличить количество данных, произведу *__аугментации данных__*.
    Как вариант можно рассмотреть применение взвешивания классов в функции потерь модели.
  ### CNN: 
  (01/11/2023)
  - Аналогичная проблема
### - [x] Модуль аугментации(генерации) данных
  (16/11/2023)
  - Класс DataGenCV (класс для аугментации данных с применением методов openCV)
  - Класс DataGenTF (класс для аугментации данных с применением методов TF)
  - Класс DataGenPW (класс для аугментации данных с применением методов Pillow)
  - У каждого класса аналогичные методы:
    - Повороты (Rotation): Поворачивание изображения на определенный угол
    - Отражение (Flip): Отражение изображения по горизонтали или вертикали.
    - Масштабирование (Scaling): Изменение размера изображения.
    - Сдвиг (Translation): Смещение изображения по горизонтали или вертикали.
    - Изменение яркости (Brightness adjustment): Изменение яркости изображения.
    - Изменение контраста (Contrast adjustment): Изменение контрастности изображения.
    - Добавление шума (Noise addition): Добавление случайного шума на изображение.
    - Обрезка (Crop): Обрезка изображения до определенного размера.
    - Цветовая аугментация (Color augmentation): Изменение цветовых характеристик изображения.
    - Размытие (Blur): Применение размытия для сглаживания изображения.
    - Комбинированные преобразования (Combined transformations): Совмещение нескольких аугментаций, чтобы создать более разнообразные варианты данных.
    - Изменение гаммы (Gamma adjustment): Изменение гаммы изображения.
    - Эластичные искажения (Elastic distortions): Применение эластичных искажений для искажения изображения.
    - Добавление случайных объектов (Random object insertion): Добавление случайных объектов на изображение.
    - Сегментация (Image segmentation): Разделение изображения на сегменты и их перемещение.


### - [x] Модуль  визуализации (отладочное)
  (16/11/2023)
### - [x] Реализована модель для сегментации на архитектуре U-Net.
  (11/12/2023)
  - Требуется больше данных и повысить точность.
### - [x] Реализованы модели для классфикации.
  (20/12/2023)
  - Как результат, я угадываю лучше чем сетка.
### - [x] Реализованы модели для выделения области интереса и определения ключевых точек.
  (11/01/2024) \
  Обучена предобученная сетка YOLOv8, которая уже умела выделять область интереса и ключевые точки,
  но не на моих данных, были размечены данные в количестве 100шт (фотоизображение) и дообучена сетка. Как результат
  области и точки выделяются, но с большой ошибкой, точность 70%, для более лучшего результата требуется больше данных.

### - [x] Реализовано определение ключевых точек с помощью OpenCV.
  (23/01/2024) \
  Предполагается что уже задний фон удален, находим контуры ног, получаем в виде матрицы.
  Далее находим самую максимальную и минимальную координату, вычисляем длину ноги и применяем пропорцию
  на данный момент сверху 60 - 30 - 10, далее по середине ноги, то есть в каждом замкнутом контуре ставим данные точки для каждой из ног.
  Где 60 - 30 - 10 полученные числа это по оси Y, а середина между двумя замкнутами контурами это X.
  Требуется улучшение. Вычилсять отдельно для каждой ноги. На данный момент высота одна и так же для каждой ноги.

### - [x] Улучшена модель сегментации U-net.
  (07/02/2024) \
  Добавлены новые и аугментированные данные, изменены гиперпараметры. Точность увеличилась до 82%.
  Необходимо еще попробовать поменять гиперпараметры и протестировать.

### - [x] Составлен финальный образ приложения.
  (09/02/2024) \
  *__На входе:__* Фотоизображение. \
  Обработка входящего изображение, определение корректные и адекватные ли данные поступили. (Сетка для отсеивания некорректных данных). \
  Обработка фотоизображения ноги с помощью модели сегментации. \
  Определение области интереса (региона). \
  Определение контуров в данной области, расстановка и определение ключевых точек. \
  Вычисление угла пронации. \
  *__На выходе:__* Изображение с отмеченым углом и соотвествующие числа, также рекомендация и вывод.

### - [x] Удаление заднего, сгементация ног.
  (11/03/2024) \
  Параметры: \
  RANDOM_STATE = 7 \
  IMAGE_SIZE = (640, 640) \
  VAL_SPLIT = 0.1 \
  BATCH_SIZE = 64 \
  SHUFFLE_BUFFER = 400 \
  LR_ALPHA = 0.3 \
  LEARNING_RATE = 1e-4 \
  EPOCHS = 25 \
  PLOTS_DPI = 150 \
  PATIENCE = 3 \
  Количество данных: 15600. \
  Точность: 91%.

### - [x] Определение ключевых точек:
  (16/03/2024) \
  IMAGE_SIZE = (640, 640) \
  EPOCHS = 100 \
  Количество данных: 300 \
  Основано на Ultralytics -> YoLo v8 n - pose. \
  mAp = 98%. \
  precision = 98% \
  recall = 98%

### - [x] Отладка кода.
  (18/03/2024) \
  Исправление ошибок в локальном проекте. \

### - [x] Новый способ определения вверхней точки.
  (12/04/2024) \
  Определяем контуры ног по отдельности, определяем среднюю точку. \
  Для средней точки слева и справа по горизонтали находим координаты контура. \
  Получается есть левая кривая и правая, собираем для каждой функцию апроксимации. \
  Функцию собираем y(x) такого вида для левой и правой части. \
  Определяем x для средней точки и для самой максимально возможной точки y. \
  Соединяем полученные точки, отдельно для каждой из сторон. \

### - [x] Отладка кода.
  (15/04/2024) \
  - Исправлен метод определения левой и правой части координат контура для определенной Y.
  - Исправлены ошибки свяанные с выбором контура.
  - Возможность кооректировки % соотношения как по горизонтали (для вверхней точки), так и по вертикали.
  - Доработана визуализация
  - Исправлены мелкие ошибки

### - [x] Начата реализация веб решения.
  (16/04/2024) \
  - Выбор фреймворка (Flask/Django/FastAPI)
  - Изучение фреймворка
  - Тестовые страницы

### - [x] Реализация макета страниц веб приложения.
  (21/04/2024) \
  - Основы Flask/SqlAlchemy
  - Реализованы макеты страниц Home/Tutorial/About


## Результат
___
  Результатом данной работы должно являться приложение веб приложение.
  Приложение должно включать:
- [ ] Подробное руководство пользователя.
- [x] Модели НС для автоматической классификации, сегментации, определения области интереса, определения ключевых точек.
- [x] Алгоритм для определения ключевых (опорных) точек.
- [x] Точность модели более 80%.

## Полезные ссылки

___

- [x] [МОИ ЗАМЕТКИ ПО ВКР(Notion)](https://www.notion.so/valeogamer/6b1b24f878ef4167a9469d566dcf8406)
- [x] [Пронация(видео)](https://youtu.be/7ec8YnKBCt0?si=XBUyKiy460pbOQat)
- [x] [КЛАССИФИКАЦИЯ ПЛОСКО-ВАЛЬГУСНОЙ ДЕФОРМАЦИИ СТОП](http://vestnik.krsu.edu.kg/archive/15/1139)

@Valeogamer, 2023-2024